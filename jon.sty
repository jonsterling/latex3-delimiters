\RequirePackage{xcolor}
\RequirePackage{xparse}
\RequirePackage{mleftright}

\ExplSyntaxOn

\seq_new:N \__delim_cmds
\seq_set_split:Nnn \__delim_cmds {,} {,\big,\Big,\bigg,\Bigg}

\cs_new:Npn \delims_apply_size:n #1 {
  \seq_item:Nn \__delim_cmds {
    \int_min:nn {\int_max:nn {#1 +1} {1}} {\seq_count:N \__delim_cmds}
  }
}


\int_new:N \__min_delim_lvl
\cs_new:Npn \delims_save:n #1 {
  \int_gset:Nn \__min_delim_lvl {0}
  \group_begin:
    #1
  \group_end:
  \int_gset:Nn \__min_delim_lvl {0}
}

\NewDocumentCommand\delimsize{m}{
  \int_gset:Nn \__min_delim_lvl {
    \int_max:nn {#1} {\__min_delim_lvl}
  }
}



\int_new:N \__delim_lvl
\int_new:N \__depth
\int_new:N \__zcoord
\int_new:N \__tmp_smoke_signal
\int_new:N \__smoke_signal
\bool_new:N \__counting_mode
\box_new:N \__delim_box

\cs_new:Npn \delims_aux:nnnn #1 #2 #3 #4 {
  \bool_if:nTF \__counting_mode {
    \group_begin:
      \bool_if:nTF #1 {\int_incr:N \__zcoord} {}
      \int_set:Nn \__tmp_smoke_signal {\__smoke_signal}
      \hbox_set:Nn \__delim_box {$#4$}
      \int_compare:nTF {\__tmp_smoke_signal = \__smoke_signal} {
        \int_gset:Nn \__depth {\__min_delim_lvl + \__zcoord}
      }{}
      \int_gincr:N \__smoke_signal
    \group_end:
  }{
    \bool_set:Nn \__counting_mode {\c_true_bool}
    \delims_aux:nnnn {#1} {#2} {#3} {#4}
    \int_set:Nn \__delim_lvl { \bool_if:nTF #1 {\__depth - 1} {\__depth} }
    \mathopen{}
    {\delims_apply_size:n \__delim_lvl #2}
    \bool_set:Nn \__counting_mode {\c_false_bool}
    \delims_save:n { #4 }
    {\delims_apply_size:n \__delim_lvl #3}
    \mathclose{}
  }
}

\NewDocumentCommand\delims{smmm}{
  \delims_aux:nnnn {#1} {#2} {#3} {#4}
}

\NewDocumentCommand\parens{sm}{
  \delims_aux:nnnn {#1} () {#2}
}

\NewDocumentCommand\brackets{sm}{
  \delims_aux:nnnn {#1} [] {#2}
}

\NewDocumentCommand\angles{sm}{
  \delims_aux:nnnn {#1} \langle\rangle {#2}
}

\ExplSyntaxOff
