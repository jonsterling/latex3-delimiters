\RequirePackage{expl3}
\RequirePackage{l3keys2e}
\RequirePackage{xparse}

\ExplSyntaxOn

\clist_new:N \l_jmsdelim_size_cmds
\clist_new:N \l_jmsdelim_fmt_cmds

\keys_define:nn { jmsdelim } {
  delimiters .clist_set:N = \l_jmsdelim_size_cmds,
  formatters .clist_set:N = \l_jmsdelim_fmt_cmds,
}

\keys_set:nn { jmsdelim } {
  delimiters = {{},\big,\Big,\bigg,\Bigg},
  formatters = {{}}
}

\int_new:N \l_jmsdelim_depth
\cs_new:Npn \jmsdelim_format_delimiter:n #1 {
  \clist_item:Nn \l_jmsdelim_fmt_cmds {
    \int_mod:nn { \int_max:nn \l_jmsdelim_depth 0 } { \clist_count:N \l_jmsdelim_fmt_cmds } + 1
  }
  \clist_item:Nn \l_jmsdelim_size_cmds {
    \int_min:nn
      { \int_max:nn {#1 + 1} {1} }
      { \clist_count:N \l_jmsdelim_size_cmds }
  }
}

\int_new:N \g_jmsdelim_min_delim_size
\bool_new:N \l_jmsdelim_counting_mode

\cs_new:Npn \jmsdelim_simple_delim:nnnn #1 #2 #3 #4 {
  \bool_if:nT \l_jmsdelim_counting_mode {
    \msg_fatal:nn {jmsdelim} {
      \jmsdelim_simple_delim:nnnn called during counting mode. this is a bug
    }
  }

  \int_set:Nn \l_tmpa_int #1
  \mathopen{}
  {\jmsdelim_format_delimiter:n \l_tmpa_int #2}
  { #4 }
  {\jmsdelim_format_delimiter:n \l_tmpa_int #3}
  \mathclose{}
}

\cs_new:Npn \jmsdelim_int_gset_monotone:Nn #1 #2 {
  \int_gset:Nn #1 {
    \int_max:nn {#1} {#2}
  }
}

\cs_new:Npn \jmsdelim_set_min_mindelim:n #1 {
  \bool_if:nT \l_jmsdelim_counting_mode {
    \jmsdelim_int_gset_monotone:Nn \g_jmsdelim_min_delim_size {#1}
  }
}


\bool_new:N \g_jmsdelim_should_bump
\cs_new:Npn \jmsdelim_delim_aux:nnnn #1 #2 #3 #4 {
  \bool_if:nTF \l_jmsdelim_counting_mode {
    \hbox_set:Nn \l_tmpa_box {$#4$}
    \bool_if:nT \g_jmsdelim_should_bump {\int_gincr:N \g_jmsdelim_min_delim_size}
    \bool_gset:Nn \g_jmsdelim_should_bump {#1}
  }{
    \group_begin:
      \bool_set:Nn \l_jmsdelim_counting_mode \c_true_bool
      \bool_gset:Nn \g_jmsdelim_should_bump {\c_false_bool}
      \int_gset:Nn \g_jmsdelim_min_delim_size {0}
      \jmsdelim_delim_aux:nnnn {#1} {#2} {#3} {#4}
    \group_end:

    \jmsdelim_simple_delim:nnnn {\g_jmsdelim_min_delim_size} {#2} {#3} {
      \int_incr:N \l_jmsdelim_depth
      #4
    }
  }
}


\NewDocumentCommand\jmsdelimsetup{+m}{
  \keys_set:nn {jmsdelim} {#1}
}

\NewDocumentCommand\mindelim{m}{
  \jmsdelim_set_min_mindelim:n {#1}
}

\NewDocumentCommand\delimsep{m}{
  {\jmsdelim_format_delimiter: #1}
}

\NewDocumentCommand\delim{+O{}smmm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} {#3} {#4} {#5}
}

\NewDocumentCommand\parens{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} () {#3}
}

\NewDocumentCommand\brackets{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} [] {#3}
}

\NewDocumentCommand\angles{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \langle\rangle {#3}
}


\NewDocumentCommand\verts{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \lvert\rvert {#3}
}

\NewDocumentCommand\braces{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \{\} {#3}
}

\NewDocumentCommand\vverts{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \lVert\rVert {#3}
}


\NewDocumentCommand\bbrackets{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \llbracket\rrbracket {#3}
}

\NewDocumentCommand\aangles{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \llangle\rrangle {#3}
}

\ProcessKeysPackageOptions {jmsdelim}

\ExplSyntaxOff
