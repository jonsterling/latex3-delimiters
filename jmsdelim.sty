\RequirePackage{expl3}
\RequirePackage{xparse}

\ExplSyntaxOn

\clist_new:N \g_jmsdelim_cmds
\clist_new:N \g_jmsdelim_format_cmds
\keys_define:nn { jmsdelim } {
  delimiters .clist_set:N = \g_jmsdelim_cmds,
  formatters .clist_set:N = \g_jmsdelim_format_cmds
}

\keys_set:nn { jmsdelim } {
  delimiters = {{},\big,\Big,\bigg,\Bigg},
  formatters = {{}}
}

\int_new:N \l_jmsdelim_delim_size_ix
\int_new:N \l_jmsdelim_formatter_ix
\cs_new:Npn \jmsdelim_format_delimiter: {
  \clist_item:Nn \g_jmsdelim_format_cmds {
    \int_mod:nn
      { \int_max:nn {\l_jmsdelim_formatter_ix } {0} }
      { \clist_count:N \g_jmsdelim_format_cmds}
      +1
  }
  \clist_item:Nn \g_jmsdelim_cmds {
    \int_min:nn
      { \int_max:nn {\l_jmsdelim_delim_size_ix + 1} {1} }
      { \clist_count:N \g_jmsdelim_cmds }
  }
}

\int_new:N \g_jmsdelim_min_delim_size
\int_new:N \g_jmsdelim_size_depth
\int_new:N \l_jmsdelim_size_depth
\int_new:N \l_jmsdelim_smoke_signal
\int_new:N \g_jmsdelim_smoke_signal
\bool_new:N \l_jmsdelim_counting_mode

\cs_new:Npn \jmsdelim_simple_delim:nnn #1 #2 #3 {
  \int_gset:Nn \g_jmsdelim_min_delim_size {0}
  \mathopen{}
  {\jmsdelim_format_delimiter: #1}
  { #3 }
  {\jmsdelim_format_delimiter: #2}
  \mathclose{}
  \int_gset:Nn \g_jmsdelim_min_delim_size {0}
}

\cs_new:Npn \jmsdelim_delim_aux:nnnn #1 #2 #3 #4 {
  \bool_if:nTF \l_jmsdelim_counting_mode {
    \group_begin:
      \bool_if:nTF #1 {\int_incr:N \l_jmsdelim_size_depth} {}
      \int_set:Nn \l_jmsdelim_smoke_signal {\g_jmsdelim_smoke_signal}
      \hbox_set:Nn \l_tmpa_box {$#4$}
      \int_compare:nT {\l_jmsdelim_smoke_signal = \g_jmsdelim_smoke_signal} {
        \int_gset:Nn \g_jmsdelim_size_depth {\g_jmsdelim_min_delim_size + \l_jmsdelim_size_depth}
      }
      \int_gincr:N \g_jmsdelim_smoke_signal
    \group_end:
  }{
    \group_begin:
      \bool_set:Nn \l_jmsdelim_counting_mode {\c_true_bool}
      \jmsdelim_delim_aux:nnnn {#1} {#2} {#3} {#4}
    \group_end:

    \int_set:Nn \l_jmsdelim_delim_size_ix {
      \g_jmsdelim_size_depth - \bool_if:nTF #1 {1} {0}
    }

    \jmsdelim_simple_delim:nnn {#2} {#3} {
      \int_incr:N \l_jmsdelim_formatter_ix
      #4
    }
  }
}

\NewDocumentCommand\jmsdelimsetup{+m}{
  \keys_set:nn {jmsdelim} {#1}
}

\NewDocumentCommand\delimsize{m}{
  \bool_if:nTF \l_jmsdelim_counting_mode {
    \int_gset:Nn \g_jmsdelim_min_delim_size {
      \int_max:nn {#1} {\g_jmsdelim_min_delim_size}
    }
  }
}

\NewDocumentCommand\delimsep{m}{
  {\jmsdelim_format_delimiter: #1}
}

\NewDocumentCommand\delim{+O{}smmm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} {#3} {#4} {#5}
}

\NewDocumentCommand\parens{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} () {#3}
}

\NewDocumentCommand\brackets{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} [] {#3}
}

\NewDocumentCommand\bbrackets{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \llbracket\rrbracket {#3}
}

\NewDocumentCommand\angles{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \langle\rangle {#3}
}


\NewDocumentCommand\verts{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \lvert\rvert {#3}
}

\NewDocumentCommand\braces{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \{\} {#3}
}

\NewDocumentCommand\Verts{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \lVert\rVert {#3}
}

\DeclareFontFamily{OMX}{MnSymbolE}{}
\DeclareSymbolFont{MnLargeSymbols}{OMX}{MnSymbolE}{m}{n}
\SetSymbolFont{MnLargeSymbols}{bold}{OMX}{MnSymbolE}{b}{n}
\DeclareFontShape{OMX}{MnSymbolE}{m}{n}{
    <-6>  MnSymbolE5
   <6-7>  MnSymbolE6
   <7-8>  MnSymbolE7
   <8-9>  MnSymbolE8
   <9-10> MnSymbolE9
  <10-12> MnSymbolE10
  <12->   MnSymbolE12
}{}
\DeclareFontShape{OMX}{MnSymbolE}{b}{n}{
    <-6>  MnSymbolE-Bold5
   <6-7>  MnSymbolE-Bold6
   <7-8>  MnSymbolE-Bold7
   <8-9>  MnSymbolE-Bold8
   <9-10> MnSymbolE-Bold9
  <10-12> MnSymbolE-Bold10
  <12->   MnSymbolE-Bold12
}{}

\let\llangle\@undefined
\let\rrangle\@undefined
\DeclareMathDelimiter{\llangle}{\mathopen}{MnLargeSymbols}{'164}{MnLargeSymbols}{'164}
\DeclareMathDelimiter{\rrangle}{\mathclose}{MnLargeSymbols}{'171}{MnLargeSymbols}{'171}

\NewDocumentCommand\Angles{+O{}sm}{
  \keys_set:nn {jmsdelim} {#1}
  \jmsdelim_delim_aux:nnnn {#2} \llangle\rrangle {#3}
}


\ExplSyntaxOff
