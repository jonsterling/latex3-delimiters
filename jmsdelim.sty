\RequirePackage{xcolor}
\RequirePackage{xparse}

\ExplSyntaxOn

\clist_new:N \__delim_cmds
\keys_define:nn { jmsdelim } {
  delimiters .clist_set:N = \__delim_cmds
}

\keys_set:nn { jmsdelim } {
  delimiters = {{}, \big,\Big,\bigg,\Bigg}
}

\int_new:N \__delim_lvl
\cs_new:Npn \jmsdelim_apply_size: {
  \clist_item:Nn \__delim_cmds {
    \int_min:nn
      { \int_max:nn {\__delim_lvl + 1} {1} }
      { \clist_count:N \__delim_cmds }
  }
}


\int_new:N \__min_delim_lvl
\cs_new:Npn \delims_save:n #1 {
  \int_gset:Nn \__min_delim_lvl {0}
  \group_begin:
    #1
  \group_end:
  \int_gset:Nn \__min_delim_lvl {0}
}


\int_new:N \g_jmsdelim_depth
\int_new:N \l_jmsdelim_depth
\int_new:N \l_jmsdelim_smoke_signal
\int_new:N \g_jmsdelim_smoke_signal
\bool_new:N \l_jmsdelim_counting_mode

\cs_new:Npn \jmsdelim_simple_delim:nnn #1 #2 #3 {
  \mathopen{}
  {\jmsdelim_apply_size: #1}
  \delims_save:n { #3 }
  {\jmsdelim_apply_size: #2}
  \mathclose{}
}

\cs_new:Npn \jmsdelim_delim_aux:nnnn #1 #2 #3 #4 {
  \bool_if:nTF \l_jmsdelim_counting_mode {
    \group_begin:
      \bool_if:nTF #1 {\int_incr:N \l_jmsdelim_depth} {}
      \int_set:Nn \l_jmsdelim_smoke_signal {\g_jmsdelim_smoke_signal}
      \hbox_set:Nn \l_tmpa_box {$#4$}
      \int_compare:nT {\l_jmsdelim_smoke_signal = \g_jmsdelim_smoke_signal} {
        \int_gset:Nn \g_jmsdelim_depth {\__min_delim_lvl + \l_jmsdelim_depth}
      }
      \int_gincr:N \g_jmsdelim_smoke_signal
    \group_end:
  }{
    \group_begin:
      \bool_set:Nn \l_jmsdelim_counting_mode {\c_true_bool}
      \jmsdelim_delim_aux:nnnn {#1} {#2} {#3} {#4}
    \group_end:

    \int_set:Nn \__delim_lvl {
      \g_jmsdelim_depth - \bool_if:nTF #1 {1} {0}
    }
    \jmsdelim_simple_delim:nnn {#2} {#3} {#4}
  }
}

\NewDocumentCommand\jmsdelimsetup{+m}{
  \keys_set:nn {jmsdelim} {#1}
}

\NewDocumentCommand\delimsize{m}{
  \int_gset:Nn \__min_delim_lvl {
    \int_max:nn {#1} {\__min_delim_lvl}
  }
}

\NewDocumentCommand\delim{smmm}{
  \jmsdelim_delim_aux:nnnn {#1} {#2} {#3} {#4}
}

\NewDocumentCommand\parens{sm}{
  \jmsdelim_delim_aux:nnnn {#1} () {#2}
}

\NewDocumentCommand\brackets{sm}{
  \jmsdelim_delim_aux:nnnn {#1} [] {#2}
}

\NewDocumentCommand\angles{sm}{
  \jmsdelim_delim_aux:nnnn {#1} \langle\rangle {#2}
}

\ExplSyntaxOff
